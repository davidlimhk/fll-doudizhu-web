// ===== Internationalization =====
const translations = {
  'zh-TW': {
    tab_score: '記分', tab_stats: '統計', tab_history: '歷史', tab_settings: '設置',
    score_title: '記分', score_landlord: '地主', score_farmer1: '農民', score_farmer2: '農民',
    score_landlord_score: '地主得分', score_select_player: '選擇玩家', score_select_score: '選擇得分',
    score_submit: '提交', score_submitting: '提交中...', score_reset: '重新輸入',
    score_farmer_preview: '每位農民得分:', score_confirm_title: '確認提交',
    score_confirm_cancel: '取消', score_confirm_submit: '提交',
    score_undo: '撤銷上一局', score_undoing: '撤銷中...',
    score_pending_sync: '條記錄待同步', score_this_round: '最新回合',
    score_no_round_data: '暫無最新回合數據', score_last_game: '載入上局玩家',
    score_select_landlord: '地主', score_select_farmer1: '農民', score_select_farmer2: '農民',
    score_select_landlord_score: '地主得分', score_select_score_title: '得分',
    score_select_short: '—', score_score_label: '得分', score_latest_round: '最新回合 - 得分', score_cancel: '取消',
    toast_submit_success: '提交成功', toast_incomplete_data: '請填寫完整的遊戲數據',
    toast_duplicate_players: '三位玩家不能重複', toast_no_url_offline: '未設置 URL，已離線保存',
    toast_offline_saved: '當前離線，已保存待同步', toast_network_error_saved: '網絡錯誤，已保存待同步',
    toast_undo_success: '已撤銷上一局', toast_undo_failed: '撤銷失敗', toast_submit_failed: '提交失敗',
    stats_title: '統計', stats_range_this_round: '最新回合', stats_range_all: '所有局數',
    stats_range_100: '最近100局', stats_range_500: '最近500局', stats_range_1000: '最近1000局',
    stats_range_sma1000: '最近參與的1000局',
    stats_header_rank: '#', stats_header_player: '玩家', stats_header_total: '總分',
    stats_header_avg: '每局', stats_header_games: '局數', stats_header_winrate: '勝率',
    stats_select_players: '選擇玩家', stats_select_players_multi: '選擇玩家（可多選）',
    stats_done: '完成', stats_trend_title: '走勢圖', stats_radar_title: '能力雷達圖',
    stats_no_data: '暫無數據', stats_loading_chart: '加載圖表數據...',
    stats_insufficient_data: '所選玩家參與局數不足 50 局，無法顯示走勢圖',
    stats_please_select_player: '請選擇玩家', stats_please_set_url: '請先在設置中配置 Web App URL',
    stats_load_failed: '加載失敗',
    trend_y_label: '最近50局平均得分', trend_x_label: '局數',
    radar_engagement: '投入度', radar_landlord_rate: '地主慾', radar_win_rate: '準成度',
    radar_volatility: '奔放度', radar_attack: '攻擊力', radar_defense: '防守力',
    radar_desc_engagement: '總參與局數', radar_desc_landlord_rate: '當地主比率',
    radar_desc_win_rate: '參與局數內勝率', radar_desc_volatility: '大勝/大敗比率',
    radar_desc_attack: '當地主勝率', radar_desc_defense: '當農民勝率', radar_games_unit: '局',
    round_trend_title: '最新回合 - 走勢', round_trend_x_label: '局數',
    history_title: '歷史', history_search_placeholder: '搜索玩家...',
    history_loading: '加載中...', history_load_more: '加載更多...', history_loaded_all: '已加載全部',
    history_load_failed_retry: '加載失敗，點擊重試', history_no_records: '暫無歷史記錄',
    history_offline_cached: '離線模式 - 顯示緩存數據', history_this_round: '最新回合',
    history_games_unit: '局', history_pending_label: '待同步',
    history_date_filter_title: '日期篩選', history_date_from: '從', history_date_to: '至',
    history_date_from_suffix: '起', history_date_to_prefix: '至',
    history_date_clear: '清除', history_date_confirm: '確定',
    history_preset_today: '今天', history_preset_this_week: '本週',
    history_preset_this_month: '本月', history_preset_last_7_days: '近7天',
    settings_title: '設置', settings_display: '顯示', settings_theme_mode: '主題模式',
    settings_theme_system: '系統', settings_theme_light: '淺色', settings_theme_dark: '深色',
    settings_font_size: '字體大小', settings_font_small: '小', settings_font_medium: '中', settings_font_large: '大',
    settings_language: '語言',
    settings_server_status: '伺服器狀態', settings_server_normal: '正常',
    settings_server_slow: '緩慢', settings_server_disconnected: '斷線',
    settings_server_testing: '檢測中...', settings_server_test_button: '測試',
    settings_offline_sync: '離線同步', settings_pending_records: '待同步記錄',
    settings_sync_now: '立即同步', settings_no_pending: '無待同步記錄',
    settings_sync_result: '同步完成', settings_sync_failed_suffix: '條失敗', settings_sync_error: '同步失敗',
    sync_panel_view_details: '查看詳情', sync_panel_hide_details: '收起',
    sync_panel_landlord_short: '地主', sync_panel_score_short: '得分',
    sync_panel_syncing: '同步中...', sync_panel_all_synced: '✓ 全部同步完成',
    sync_panel_sync_now: '立即同步', sync_panel_sync_failed: '同步失敗',
    sync_panel_force_clear: '強制清除',
    sync_panel_force_clear_confirm: '確定要強制清除所有待同步記錄嗎？這些記錄將不會被上傳到伺服器。',
    sync_panel_cleared: '已清除', sync_panel_last_error: '上次同步錯誤',
    sync_panel_server_offline: '請先連接伺服器',
    pending_action_title: '操作', pending_action_edit: '編輯', pending_action_delete: '刪除',
    pending_action_delete_confirm: '確定要刪除這條待同步記錄嗎？',
    settings_about: '關於', settings_app_version: 'App 版本',
    settings_script_version: 'Apps Script 版本',
    settings_about_desc_prefix: '數據儲存於', settings_about_desc_suffix: '，支持離線同步。',
    settings_audio: '音效', settings_bgm: '背景音樂', settings_bgm_desc: '播放中國風背景音樂',
    settings_sfx: '音效', settings_sfx_desc: '按鈕點擊和提交成功音效',
    settings_login_validity: '登入有效期',
    auth_permission_role: '權限角色', auth_role_owner: '擁有者', auth_role_editor: '編輯者',
    auth_cache_expired: '已過期',
    auth_login_title: 'FLL365', auth_login_subtitle: '',
    auth_login_button: '登入', auth_logging_in: '登入中...',
    auth_logout: '登出', auth_logged_in_as: '已登入：',
    auth_relogin_settings: '登出', auth_relogin_settings_desc: '登出後重新進行身份驗證',
    auth_app_version: '版本',
    auth_checking: '正在檢查權限...', auth_check_failed: '無法連接伺服器',
    auth_retry: '重試', auth_no_access: '沒有編輯權限',
    auth_denied_msg: '你沒有此 Google Sheet 的編輯權限。請聯繫管理員授權。',
    auth_recheck: '重新檢查', auth_switch_account: '切換帳號',
    auth_invalid_email: '請輸入有效的 Email 地址',
    auth_login_btn: '登入',
    auth_google_signin: '使用 Google 登入', auth_google_signin_loading: '正在載入 Google 登入...',
    offline_banner: '離線模式', offline_retry: '重試',
    toast_sync_success: '同步完成，已上傳 {count} 條記錄',
    common_loading: '加載中...', common_confirm: '確認', common_error: '錯誤', common_unknown: '未知',
    settings_refresh_data: '刷新數據', settings_refreshing_data: '刷新中...', settings_refresh_data_done: '數據已刷新',
  },
  'zh-CN': {
    tab_score: '记分', tab_stats: '统计', tab_history: '历史', tab_settings: '设置',
    score_title: '记分', score_landlord: '地主', score_farmer1: '农民', score_farmer2: '农民',
    score_landlord_score: '地主得分', score_select_player: '选择玩家', score_select_score: '选择得分',
    score_submit: '提交', score_submitting: '提交中...', score_reset: '重新输入',
    score_farmer_preview: '每位农民得分:', score_confirm_title: '确认提交',
    score_confirm_cancel: '取消', score_confirm_submit: '提交',
    score_undo: '撤销上一局', score_undoing: '撤销中...',
    score_pending_sync: '条记录待同步', score_this_round: '最新回合',
    score_no_round_data: '暂无最新回合数据', score_last_game: '载入上局玩家',
    score_select_landlord: '地主', score_select_farmer1: '农民', score_select_farmer2: '农民',
    score_select_landlord_score: '地主得分', score_select_score_title: '得分',
    score_select_short: '—', score_score_label: '得分', score_latest_round: '最新回合 - 得分', score_cancel: '取消',
    toast_submit_success: '提交成功', toast_incomplete_data: '请填写完整的游戏数据',
    toast_duplicate_players: '三位玩家不能重复', toast_no_url_offline: '未设置 URL，已离线保存',
    toast_offline_saved: '当前离线，已保存待同步', toast_network_error_saved: '网络错误，已保存待同步',
    toast_undo_success: '已撤销上一局', toast_undo_failed: '撤销失败', toast_submit_failed: '提交失败',
    stats_title: '统计', stats_range_this_round: '最新回合', stats_range_all: '所有局数',
    stats_range_100: '最近100局', stats_range_500: '最近500局', stats_range_1000: '最近1000局',
    stats_range_sma1000: '最近参与的1000局',
    stats_header_rank: '#', stats_header_player: '玩家', stats_header_total: '总分',
    stats_header_avg: '每局', stats_header_games: '局数', stats_header_winrate: '胜率',
    stats_select_players: '选择玩家', stats_select_players_multi: '选择玩家（可多选）',
    stats_done: '完成', stats_trend_title: '走势图', stats_radar_title: '能力雷达图',
    stats_no_data: '暂无数据', stats_loading_chart: '加载图表数据...',
    stats_insufficient_data: '所选玩家参与局数不足 50 局，无法显示走势图',
    stats_please_select_player: '请选择玩家', stats_please_set_url: '请先在设置中配置 Web App URL',
    stats_load_failed: '加载失败',
    trend_y_label: '最近50局平均得分', trend_x_label: '局数',
    radar_engagement: '投入度', radar_landlord_rate: '地主欲', radar_win_rate: '准成度',
    radar_volatility: '奔放度', radar_attack: '攻击力', radar_defense: '防守力',
    radar_desc_engagement: '总参与局数', radar_desc_landlord_rate: '当地主比率',
    radar_desc_win_rate: '参与局数内胜率', radar_desc_volatility: '大胜/大败比率',
    radar_desc_attack: '当地主胜率', radar_desc_defense: '当农民胜率', radar_games_unit: '局',
    round_trend_title: '最新回合 - 走势', round_trend_x_label: '局数',
    history_title: '历史', history_search_placeholder: '搜索玩家...',
    history_loading: '加载中...', history_load_more: '加载更多...', history_loaded_all: '已加载全部',
    history_load_failed_retry: '加载失败，点击重试', history_no_records: '暂无历史记录',
    history_offline_cached: '离线模式 - 显示缓存数据', history_this_round: '最新回合',
    history_games_unit: '局', history_pending_label: '待同步',
    history_date_filter_title: '日期筛选', history_date_from: '从', history_date_to: '至',
    history_date_from_suffix: '起', history_date_to_prefix: '至',
    history_date_clear: '清除', history_date_confirm: '确定',
    history_preset_today: '今天', history_preset_this_week: '本周',
    history_preset_this_month: '本月', history_preset_last_7_days: '近7天',
    settings_title: '设置', settings_display: '显示', settings_theme_mode: '主题模式',
    settings_theme_system: '系统', settings_theme_light: '浅色', settings_theme_dark: '深色',
    settings_font_size: '字体大小', settings_font_small: '小', settings_font_medium: '中', settings_font_large: '大',
    settings_language: '语言',
    settings_server_status: '服务器状态', settings_server_normal: '正常',
    settings_server_slow: '缓慢', settings_server_disconnected: '断线',
    settings_server_testing: '检测中...', settings_server_test_button: '测试',
    settings_offline_sync: '离线同步', settings_pending_records: '待同步记录',
    settings_sync_now: '立即同步', settings_no_pending: '无待同步记录',
    settings_sync_result: '同步完成', settings_sync_failed_suffix: '条失败', settings_sync_error: '同步失败',
    sync_panel_view_details: '查看详情', sync_panel_hide_details: '收起',
    sync_panel_landlord_short: '地主', sync_panel_score_short: '得分',
    sync_panel_syncing: '同步中...', sync_panel_all_synced: '✓ 全部同步完成',
    sync_panel_sync_now: '立即同步', sync_panel_sync_failed: '同步失败',
    sync_panel_force_clear: '强制清除',
    sync_panel_force_clear_confirm: '确定要强制清除所有待同步记录吗？这些记录将不会被上传到服务器。',
    sync_panel_cleared: '已清除', sync_panel_last_error: '上次同步错误',
    sync_panel_server_offline: '请先连接服务器',
    pending_action_title: '操作', pending_action_edit: '编辑', pending_action_delete: '删除',
    pending_action_delete_confirm: '确定要删除这条待同步记录吗？',
    settings_about: '关于', settings_app_version: 'App 版本',
    settings_script_version: 'Apps Script 版本',
    settings_about_desc_prefix: '数据储存于', settings_about_desc_suffix: '，支持离线同步。',
    settings_audio: '音效', settings_bgm: '背景音乐', settings_bgm_desc: '播放中国风背景音乐',
    settings_sfx: '音效', settings_sfx_desc: '按钮点击和提交成功音效',
    settings_login_validity: '登录有效期',
    auth_permission_role: '权限角色', auth_role_owner: '拥有者', auth_role_editor: '编辑者',
    auth_cache_expired: '已过期',
    auth_login_title: 'FLL365', auth_login_subtitle: '',
    auth_login_button: '登录', auth_logging_in: '登录中...',
    auth_logout: '登出', auth_logged_in_as: '已登录：',
    auth_relogin_settings: '登出', auth_relogin_settings_desc: '登出后重新进行身份验证',
    auth_app_version: '版本',
    auth_checking: '正在检查权限...', auth_check_failed: '无法连接服务器',
    auth_retry: '重试', auth_no_access: '没有编辑权限',
    auth_denied_msg: '你没有此 Google Sheet 的编辑权限。请联系管理员授权。',
    auth_recheck: '重新检查', auth_switch_account: '切换账号',
    auth_invalid_email: '请输入有效的 Email 地址',
    auth_login_btn: '登录',
    auth_google_signin: '使用 Google 登录', auth_google_signin_loading: '正在加载 Google 登录...',
    offline_banner: '离线模式', offline_retry: '重试',
    toast_sync_success: '同步完成，已上传 {count} 条记录',
    common_loading: '加载中...', common_confirm: '确认', common_error: '错误', common_unknown: '未知',
    settings_refresh_data: '刷新数据', settings_refreshing_data: '刷新中...', settings_refresh_data_done: '数据已刷新',
  },
  'en': {
    tab_score: 'Score', tab_stats: 'Stats', tab_history: 'History', tab_settings: 'Settings',
    score_title: 'Score', score_landlord: 'Landlord', score_farmer1: 'Farmer', score_farmer2: 'Farmer',
    score_landlord_score: 'Landlord Score', score_select_player: 'Select Player', score_select_score: 'Select Score',
    score_submit: 'Submit', score_submitting: 'Submitting...', score_reset: 'Reset',
    score_farmer_preview: 'Each farmer score:', score_confirm_title: 'Confirm Submit',
    score_confirm_cancel: 'Cancel', score_confirm_submit: 'Submit',
    score_undo: 'Undo Last Game', score_undoing: 'Undoing...',
    score_pending_sync: 'records pending sync', score_this_round: 'Latest',
    score_no_round_data: 'No round data yet', score_last_game: 'Load Last Players',
    score_select_landlord: 'Lord', score_select_farmer1: 'Farmer', score_select_farmer2: 'Farmer',
    score_select_landlord_score: 'Score', score_select_score_title: 'Score',
    score_select_short: '—', score_score_label: 'Score', score_latest_round: 'Latest Round - Scores', score_cancel: 'Cancel',
    toast_submit_success: 'Submitted successfully', toast_incomplete_data: 'Please fill in all game data',
    toast_duplicate_players: 'Players must be different', toast_no_url_offline: 'No URL set, saved offline',
    toast_offline_saved: 'Offline, saved for sync', toast_network_error_saved: 'Network error, saved for sync',
    toast_undo_success: 'Last game undone', toast_undo_failed: 'Undo failed', toast_submit_failed: 'Submit failed',
    stats_title: 'Statistics', stats_range_this_round: 'Latest', stats_range_all: 'All Games',
    stats_range_100: 'Last 100', stats_range_500: 'Last 500', stats_range_1000: 'Last 1000',
    stats_range_sma1000: 'Last 1000 Played',
    stats_header_rank: '#', stats_header_player: 'Player', stats_header_total: 'Total',
    stats_header_avg: 'Avg', stats_header_games: 'Games', stats_header_winrate: 'Win%',
    stats_select_players: 'Select Players', stats_select_players_multi: 'Select Players (multi)',
    stats_done: 'Done', stats_trend_title: 'Trend Chart', stats_radar_title: 'Ability Radar',
    stats_no_data: 'No data', stats_loading_chart: 'Loading chart data...',
    stats_insufficient_data: 'Selected players have fewer than 50 games',
    stats_please_select_player: 'Please select a player', stats_please_set_url: 'Please configure Web App URL in Settings',
    stats_load_failed: 'Load failed',
    trend_y_label: 'Last 50 Avg Score', trend_x_label: 'Games',
    radar_engagement: 'Engagement', radar_landlord_rate: 'LL Desire', radar_win_rate: 'Accuracy',
    radar_volatility: 'Boldness', radar_attack: 'Attack Power', radar_defense: 'Defense',
    radar_desc_engagement: 'Total games played', radar_desc_landlord_rate: 'Rate of being landlord',
    radar_desc_win_rate: 'Overall win rate', radar_desc_volatility: 'Rate of big wins/losses',
    radar_desc_attack: 'Win rate as landlord', radar_desc_defense: 'Win rate as farmer', radar_games_unit: ' games',
    round_trend_title: 'Latest Round - Trend', round_trend_x_label: 'Games',
    history_title: 'History', history_search_placeholder: 'Search player...',
    history_loading: 'Loading...', history_load_more: 'Load more...', history_loaded_all: 'All loaded',
    history_load_failed_retry: 'Load failed. Tap to retry', history_no_records: 'No history records',
    history_offline_cached: 'Offline - showing cached data', history_this_round: 'Latest',
    history_games_unit: 'games', history_pending_label: 'pending',
    history_date_filter_title: 'Date Filter', history_date_from: 'From', history_date_to: 'To',
    history_date_from_suffix: 'onwards', history_date_to_prefix: 'until',
    history_date_clear: 'Clear', history_date_confirm: 'Apply',
    history_preset_today: 'Today', history_preset_this_week: 'This Week',
    history_preset_this_month: 'This Month', history_preset_last_7_days: 'Last 7 Days',
    settings_title: 'Settings', settings_display: 'Display', settings_theme_mode: 'Theme',
    settings_theme_system: 'System', settings_theme_light: 'Light', settings_theme_dark: 'Dark',
    settings_font_size: 'Font Size', settings_font_small: 'S', settings_font_medium: 'M', settings_font_large: 'L',
    settings_language: 'Language',
    settings_server_status: 'Server Status', settings_server_normal: 'Normal',
    settings_server_slow: 'Slow', settings_server_disconnected: 'Disconnected',
    settings_server_testing: 'Testing...', settings_server_test_button: 'Test',
    settings_offline_sync: 'Offline Sync', settings_pending_records: 'Pending Records',
    settings_sync_now: 'Sync Now', settings_no_pending: 'No pending records',
    settings_sync_result: 'Sync complete', settings_sync_failed_suffix: 'failed', settings_sync_error: 'Sync failed',
    sync_panel_view_details: 'View Details', sync_panel_hide_details: 'Hide',
    sync_panel_landlord_short: 'LL', sync_panel_score_short: 'Score',
    sync_panel_syncing: 'Syncing...', sync_panel_all_synced: '✓ All synced',
    sync_panel_sync_now: 'Sync Now', sync_panel_sync_failed: 'Sync failed',
    sync_panel_force_clear: 'Force Clear',
    sync_panel_force_clear_confirm: 'Force clear all pending records? They will NOT be uploaded.',
    sync_panel_cleared: 'Cleared', sync_panel_last_error: 'Last sync error',
    sync_panel_server_offline: 'Connect to server first',
    pending_action_title: 'Actions', pending_action_edit: 'Edit', pending_action_delete: 'Delete',
    pending_action_delete_confirm: 'Delete this pending record?',
    settings_about: 'About', settings_app_version: 'App Version',
    settings_script_version: 'Apps Script Version',
    settings_about_desc_prefix: 'Data stored in the ', settings_about_desc_suffix: ', supports offline sync.',
    settings_audio: 'Audio', settings_bgm: 'Background Music', settings_bgm_desc: 'Play Chinese-style background music',
    settings_sfx: 'Sound Effects', settings_sfx_desc: 'Button tap and submit success sounds',
    settings_login_validity: 'Login Validity',
    auth_permission_role: 'Permission Role', auth_role_owner: 'Owner', auth_role_editor: 'Editor',
    auth_cache_expired: 'Expired',
    auth_login_title: 'FLL365', auth_login_subtitle: '',
    auth_login_button: 'Sign In', auth_logging_in: 'Signing in...',
    auth_logout: 'Sign Out', auth_logged_in_as: 'Signed in as:',
    auth_relogin_settings: 'Sign Out', auth_relogin_settings_desc: 'Sign out and sign in again',
    auth_app_version: 'Version',
    auth_checking: 'Checking permissions...', auth_check_failed: 'Cannot connect to server',
    auth_retry: 'Retry', auth_no_access: 'No edit access',
    auth_denied_msg: 'You do not have edit access to this Google Sheet. Please contact the administrator.',
    auth_recheck: 'Recheck', auth_switch_account: 'Switch Account',
    auth_invalid_email: 'Please enter a valid email address',
    auth_login_btn: 'Sign In',
    auth_google_signin: 'Sign in with Google', auth_google_signin_loading: 'Loading Google Sign-In...',
    offline_banner: 'Offline Mode', offline_retry: 'Retry',
    toast_sync_success: 'Sync complete, {count} records uploaded',
    common_loading: 'Loading...', common_confirm: 'Confirm', common_error: 'Error', common_unknown: 'Unknown',
    settings_refresh_data: 'Refresh Data', settings_refreshing_data: 'Refreshing...', settings_refresh_data_done: 'Data refreshed',
  }
};

function t(key) {
  const lang = AppState.settings.language || 'zh-TW';
  return (translations[lang] && translations[lang][key]) || translations['zh-TW'][key] || key;
}
